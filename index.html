<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel for running React in the browser (GitHub Pages ready) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-rose-50">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        // REPLACE THIS OBJECT WITH YOUR FIREBASE CONFIG FROM STEP 1
        const firebaseConfig = {
            apiKey: "AIzaSyDlAGuz0l5gGPvWDYyhDz97DSIRY8b2asA",
            authDomain: "jtp-secret-santa.firebaseapp.com",
            projectId: "jtp-secret-santa",
            storageBucket: "jtp-secret-santa.firebasestorage.app",
            messagingSenderId: "171337796088",
            appId: "1:171337796088:web:91c316fcd4046b2ec8ee0d",
            measurementId: "G-J1DNGXKRWF"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = 'secret-santa-coordinator';

        const { useState, useEffect } = React;

        const App = () => {
            const [activeTab, setActiveTab] = useState('join');
            const [currentSession, setCurrentSession] = useState(null);
            const [participants, setParticipants] = useState([]);
            const [notification, setNotification] = useState(null);
            const [loading, setLoading] = useState(true);

            // Form States
            const [email, setEmail] = useState('');
            const [code, setCode] = useState('');
            const [name, setName] = useState('');

            useEffect(() => {
                auth.signInAnonymously().catch(console.error);
                auth.onAuthStateChanged(() => setLoading(false));
            }, []);

            useEffect(() => {
                if (!currentSession) return;
                const unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data')
                    .collection(`participants_${currentSession.code}`)
                    .onSnapshot(snapshot => {
                        setParticipants(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                return () => unsubscribe();
            }, [currentSession]);

            const notify = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 4000);
            };

            const handleHost = async (e) => {
                e.preventDefault();
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let newCode = '';
                for (let i = 0; i < 6; i++) newCode += chars.charAt(Math.floor(Math.random() * chars.length));

                const sessionData = {
                    code: newCode,
                    organizerEmail: email,
                    status: 'open',
                    createdAt: new Date().toISOString()
                };

                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data')
                        .collection('sessions').doc(newCode).set(sessionData);
                    setCurrentSession(sessionData);
                    setActiveTab('dashboard');
                    notify(`Session ${newCode} created!`);
                } catch (err) {
                    notify("Error creating session. Check Firebase rules.", "error");
                }
            };

            const handleJoin = async (e) => {
                e.preventDefault();
                const sessionCode = code.toUpperCase().trim();
                const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data')
                    .collection('sessions').doc(sessionCode).get();

                if (!doc.exists) return notify("Invalid code.", "error");
                if (doc.data().status !== 'open') return notify("Session closed.", "error");

                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data')
                        .collection(`participants_${sessionCode}`).add({ name, email });
                    notify("You've joined!");
                    setName(''); setEmail(''); setCode('');
                } catch (err) {
                    notify("Error joining.", "error");
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                const sessionCode = code.toUpperCase().trim();
                const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data')
                    .collection('sessions').doc(sessionCode).get();

                if (doc.exists && doc.data().organizerEmail === email) {
                    setCurrentSession(doc.data());
                    setActiveTab('dashboard');
                    notify("Logged in!");
                } else {
                    notify("Invalid credentials.", "error");
                }
            };

            const handleDraw = async () => {
                if (participants.length < 3) return notify("Need at least 3 people!", "error");
                const givers = [...participants];
                let receivers = [...participants];
                let valid = false;
                while (!valid) {
                    receivers.sort(() => Math.random() - 0.5);
                    valid = givers.every((g, i) => g.email !== receivers[i].email);
                }
                const results = givers.map((g, i) => ({ from: g.name, to: receivers[i].name }));
                await db.collection('artifacts').doc(appId).collection('public').doc('data')
                    .collection('sessions').doc(currentSession.code).update({ status: 'completed', results });
                setCurrentSession(prev => ({ ...prev, status: 'completed', results }));
                notify("Draw complete!");
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-rose-600">Santa is loading...</div>;

            return (
                <div className="max-w-xl mx-auto p-4 md:p-8">
                    <header className="text-center mb-8">
                        <div className="bg-rose-600 text-white p-3 rounded-2xl inline-block shadow-lg mb-4">üéÅ</div>
                        <h1 className="text-3xl font-black text-rose-700">Secret Santa <span className="bg-slate-800 text-white text-xs px-2 py-1 rounded ml-1">CLOUD</span></h1>
                    </header>

                    {notification && (
                        <div className={`fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-xl z-50 text-white font-bold text-sm ${notification.type === 'error' ? 'bg-slate-900' : 'bg-rose-600'}`}>
                            {notification.msg}
                        </div>
                    )}

                    {!currentSession && (
                        <div className="flex bg-white/50 p-1 rounded-xl mb-6 shadow-sm border border-rose-100">
                            {['join', 'host', 'login'].map(t => (
                                <button key={t} onClick={() => setActiveTab(t)} className={`flex-1 py-2 rounded-lg font-bold capitalize text-sm ${activeTab === t ? 'bg-rose-600 text-white' : 'text-slate-500'}`}>{t}</button>
                            ))}
                        </div>
                    )}

                    <div className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-rose-100">
                        {activeTab === 'join' && !currentSession && (
                            <form onSubmit={handleJoin} className="space-y-4">
                                <h2 className="text-xl font-bold">Join Exchange</h2>
                                <input required maxLength="6" className="w-full p-4 bg-slate-50 border rounded-xl text-center font-mono text-xl uppercase text-rose-600 font-bold outline-none" placeholder="CODE" value={code} onChange={e => setCode(e.target.value)} />
                                <input required className="w-full p-4 bg-slate-50 border rounded-xl outline-none" placeholder="Your Name" value={name} onChange={e => setName(e.target.value)} />
                                <input required type="email" className="w-full p-4 bg-slate-50 border rounded-xl outline-none" placeholder="Your Email" value={email} onChange={e => setEmail(e.target.value)} />
                                <button className="w-full py-4 bg-rose-600 text-white font-black rounded-xl shadow-lg">JOIN CIRCLE</button>
                            </form>
                        )}

                        {activeTab === 'host' && !currentSession && (
                            <form onSubmit={handleHost} className="space-y-4">
                                <h2 className="text-xl font-bold">New Exchange</h2>
                                <input required type="email" className="w-full p-4 bg-slate-50 border rounded-xl outline-none" placeholder="Your Organizer Email" value={email} onChange={e => setEmail(e.target.value)} />
                                <button className="w-full py-4 bg-rose-600 text-white font-black rounded-xl shadow-lg uppercase">Create Code</button>
                            </form>
                        )}

                        {activeTab === 'login' && !currentSession && (
                            <form onSubmit={handleLogin} className="space-y-4">
                                <h2 className="text-xl font-bold">Organizer Login</h2>
                                <input required type="email" className="w-full p-4 bg-slate-50 border rounded-xl outline-none" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} />
                                <input required maxLength="6" className="w-full p-4 bg-slate-50 border rounded-xl text-center font-mono uppercase outline-none" placeholder="Session Code" value={code} onChange={e => setCode(e.target.value)} />
                                <button className="w-full py-4 bg-slate-900 text-white font-black rounded-xl">LOGIN</button>
                            </form>
                        )}

                        {currentSession && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center border-b pb-4">
                                    <h2 className="text-2xl font-black text-rose-600 font-mono uppercase">{currentSession.code}</h2>
                                    <button onClick={() => setCurrentSession(null)} className="text-slate-400 font-bold text-xs uppercase">Logout</button>
                                </div>
                                <div className="bg-rose-50 p-4 rounded-xl border border-rose-100">
                                    <h4 className="font-bold text-rose-800 text-xs uppercase mb-2">Participants ({participants.length})</h4>
                                    <div className="flex flex-wrap gap-2">
                                        {participants.map(p => <span key={p.id} className="bg-white px-2 py-1 rounded border text-[10px] font-bold text-slate-600">{p.name}</span>)}
                                    </div>
                                </div>
                                {currentSession.status === 'open' ? (
                                    <button onClick={handleDraw} className="w-full py-4 bg-rose-600 text-white font-black rounded-xl shadow-lg">DRAW PAIRS</button>
                                ) : (
                                    <div className="space-y-2">
                                        <p className="text-[10px] font-bold text-center text-slate-400 uppercase">Draw Results</p>
                                        {currentSession.results?.map((p, i) => (
                                            <div key={i} className="flex justify-between p-2 bg-slate-50 rounded text-xs border border-slate-100">
                                                <span className="font-bold">{p.from}</span> <span className="text-rose-600 font-black">‚Üí {p.to}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
